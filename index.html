<!DOCTYPE html>
<html>
  <head>
    <title>GitHub Save Test</title>
  </head>
  <body>
    <button onclick="saveTestUser()">Save Test User</button>
   <script>
const GITHUB_TOKEN = "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"; // Keep it private!
const REPO = "loadbit6/shared-auth";
const FILE_PATH = "shared-auth.json";
const BRANCH = "main";

const testUser = {
  username: "testing123",
  passwordHash: "testhash",
  cookies: { theme: "light" }
};

async function saveTestUser() {
  alert("Attempting to fetch the file...");

  const apiURL = `https://api.github.com/repos/${REPO}/contents/${FILE_PATH}`;

  // Fetch the file
  const res = await fetch(apiURL, {
    headers: {
      Authorization: `Bearer ${GITHUB_TOKEN}`,
      Accept: "application/vnd.github.v3+json"
    }
  });

  if (!res.ok) {
    const errorMessage = await res.text();
    alert("❌ Failed to read file: " + errorMessage);
    return;
  }

  alert("File fetched successfully!");

  const fileData = await res.json();
  const existing = JSON.parse(atob(fileData.content));

  // Add new user
  existing.users = existing.users || {};
  existing.users[testUser.username] = {
    passwordHash: testUser.passwordHash,
    cookies: testUser.cookies
  };

  const updatedContent = btoa(JSON.stringify(existing, null, 2));

  // Update the file on GitHub
  const putRes = await fetch(apiURL, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${GITHUB_TOKEN}`,
      Accept: "application/vnd.github.v3+json"
    },
    body: JSON.stringify({
      message: "Add test user",
      content: updatedContent,
      sha: fileData.sha,
      branch: BRANCH
    })
  });

  if (!putRes.ok) {
    const errorMessage = await putRes.text();
    alert("❌ Save failed: " + errorMessage);
  } else {
    alert("✅ File saved successfully!");
  }
}
</script>
  </body>
</html>
